when:
  event:
    - push
    - manual

steps:
  init:
    image: codeberg.org/${CI_REPO_OWNER}/sveltekit-robinopletal-buildimage
    pull: true
    commands:
      - vercel --token $${VERCEL} project add chloewinkel-v2
      - vercel --token $${VERCEL} link -p chloewinkel-v2 --yes
    secrets: [VERCEL]

  deploy-preview:
    image: codeberg.org/${CI_REPO_OWNER}/sveltekit-robinopletal-buildimage
    pull: true
    commands:
      - vercel --token $${VERCEL} deploy | tee url.txt
    secrets: [VERCEL]

  deploy-production:
    image: codeberg.org/${CI_REPO_OWNER}/sveltekit-robinopletal-buildimage
    pull: true
    commands:
      - vercel --token $${VERCEL} promote `cat url.txt` --yes
    secrets: [VERCEL]
    when:
      - evaluate: CI_COMMIT_BRANCH == CI_REPO_DEFAULT_BRANCH
